<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <title>ì±„íŒ…ë°©</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: #b2c7d9;
      height: 100vh;
      height: 100dvh; /* ëª¨ë°”ì¼ ë™ì  ë·°í¬íŠ¸ ë†’ì´ */
      overflow: hidden;
      position: fixed;
      width: 100%;
      -webkit-overflow-scrolling: touch;
    }

    .chat-container {
      display: flex;
      height: 100vh;
      height: 100dvh; /* ëª¨ë°”ì¼ ë™ì  ë·°í¬íŠ¸ ë†’ì´ */
      max-width: 1400px;
      margin: 0 auto;
      position: relative;
    }

    /* ì±„íŒ… ì˜ì—­ */
    .chat-main {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: #b2c7d9;
    }

    /* í—¤ë” */
    .chat-header {
      background: #a0b4c7;
      padding: 15px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid #8a9fb3;
    }

    .chat-title {
      font-size: 18px;
      font-weight: 600;
      color: #3c1e1e;
    }

    .header-buttons {
      display: flex;
      gap: 10px;
    }

    .header-btn {
      padding: 8px 15px;
      background: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      color: #333;
      transition: background 0.2s;
    }

    .header-btn:hover {
      background: #f0f0f0;
    }

    /* ë©”ì‹œì§€ ì˜ì—­ */
    .messages-container {
      flex: 1;
      overflow-y: auto;
      overflow-x: hidden;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      -webkit-overflow-scrolling: touch;
      overscroll-behavior: contain;
    }

    /* ì‹œìŠ¤í…œ ë©”ì‹œì§€ */
    .system-message {
      text-align: center;
      color: #666;
      font-size: 13px;
      padding: 5px 0;
    }

    /* ë©”ì‹œì§€ ë˜í¼ */
    .message-wrapper {
      display: flex;
      align-items: flex-end;
      gap: 8px;
      max-width: 70%;
    }

    .message-wrapper.mine {
      margin-left: auto;
      flex-direction: row-reverse;
    }

    .message-wrapper.others {
      margin-right: auto;
    }

    /* ë‹‰ë„¤ì„ */
    .nickname {
      font-size: 12px;
      font-weight: 600;
      color: #333;
      margin-bottom: 4px;
      padding-left: 8px;
    }

    .message-wrapper.mine .nickname {
      display: none;
    }

    /* ë©”ì‹œì§€ ë²„ë¸” */
    .message-content {
      display: flex;
      flex-direction: column;
      max-width: 100%;
    }

    .message-bubble {
      padding: 10px 14px;
      border-radius: 18px;
      font-size: 15px;
      line-height: 1.5;
      word-wrap: break-word;
      white-space: pre-wrap;
    }

    .message-wrapper.mine .message-bubble {
      background: #ffe200;
      color: #3c1e1e;
      border-bottom-right-radius: 4px;
    }

    .message-wrapper.others .message-bubble {
      background: white;
      color: #3c1e1e;
      border-bottom-left-radius: 4px;
    }

    /* íƒ€ì„ìŠ¤íƒ¬í”„ */
    .timestamp {
      font-size: 11px;
      color: #666;
      padding: 0 5px;
      align-self: flex-end;
    }

    /* ì…ë ¥ ì˜ì—­ */
    .input-container {
      background: white;
      padding: 15px 20px;
      padding-bottom: max(15px, env(safe-area-inset-bottom)); /* iOS ë…¸ì¹˜ ëŒ€ì‘ */
      border-top: 1px solid #d0d0d0;
      position: relative;
      z-index: 100;
    }

    .input-wrapper {
      display: flex;
      gap: 10px;
      align-items: flex-end;
    }

    #messageInput {
      flex: 1;
      padding: 12px 15px;
      border: 1px solid #d0d0d0;
      border-radius: 8px;
      font-size: 16px; /* iOS ìë™ ì¤Œ ë°©ì§€ */
      font-family: inherit;
      resize: none;
      min-height: 44px;
      max-height: 120px;
      overflow-y: auto;
      -webkit-appearance: none;
      appearance: none;
    }

    #messageInput:focus {
      outline: none;
      border-color: #ffe200;
    }

    #sendBtn {
      padding: 12px 25px;
      background: #ffe200;
      border: none;
      border-radius: 8px;
      font-size: 15px;
      font-weight: 600;
      color: #3c1e1e;
      cursor: pointer;
      transition: background 0.2s;
      white-space: nowrap;
    }

    #sendBtn:hover {
      background: #ffd700;
    }

    #sendBtn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* ì‚¬ì´ë“œ íŒ¨ë„ (ë‹¨ì¶•í‚¤ ì„¤ëª…) */
    .side-panel {
      width: 300px;
      background: white;
      border-left: 1px solid #d0d0d0;
      padding: 20px;
      overflow-y: auto;
    }

    .side-panel h3 {
      font-size: 16px;
      margin-bottom: 15px;
      color: #333;
      padding-bottom: 10px;
      border-bottom: 2px solid #ffe200;
    }

    .shortcut-list {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .shortcut-item {
      padding: 12px;
      background: #f8f9fa;
      border-radius: 8px;
    }

    .shortcut-key {
      font-weight: 600;
      color: #667eea;
      font-size: 14px;
      margin-bottom: 5px;
    }

    .shortcut-desc {
      font-size: 13px;
      color: #666;
      line-height: 1.4;
    }

    .info-section {
      margin-top: 30px;
      padding-top: 20px;
      border-top: 1px solid #e0e0e0;
    }

    .info-section h4 {
      font-size: 14px;
      margin-bottom: 10px;
      color: #333;
    }

    .info-text {
      font-size: 12px;
      color: #666;
      line-height: 1.6;
    }

    /* ìŠ¤í¬ë¡¤ë°” ìŠ¤íƒ€ì¼ */
    .messages-container::-webkit-scrollbar,
    .side-panel::-webkit-scrollbar {
      width: 8px;
    }

    .messages-container::-webkit-scrollbar-track,
    .side-panel::-webkit-scrollbar-track {
      background: transparent;
    }

    .messages-container::-webkit-scrollbar-thumb,
    .side-panel::-webkit-scrollbar-thumb {
      background: rgba(0, 0, 0, 0.2);
      border-radius: 4px;
    }

    /* ë°˜ì‘í˜• */
    @media (max-width: 768px) {
      .side-panel {
        display: none;
      }

      .message-wrapper {
        max-width: 85%;
      }

      .chat-header {
        padding: 12px 15px;
      }

      .header-btn {
        padding: 6px 12px;
        font-size: 12px;
      }

      .messages-container {
        padding: 15px 10px;
      }

      .input-container {
        padding: 12px 10px;
        padding-bottom: max(12px, env(safe-area-inset-bottom));
      }

      #messageInput {
        font-size: 16px; /* iOS ìë™ ì¤Œ ë°©ì§€ */
        min-height: 40px;
      }

      #sendBtn {
        padding: 10px 18px;
        font-size: 14px;
      }
    }

    /* iOS Safari í‚¤ë³´ë“œ ëŒ€ì‘ */
    @supports (-webkit-touch-callout: none) {
      body {
        height: -webkit-fill-available;
      }

      .chat-container {
        height: -webkit-fill-available;
      }
    }
  </style>
</head>
<body>
  <div class="chat-container">
    <!-- ë©”ì¸ ì±„íŒ… ì˜ì—­ -->
    <div class="chat-main">
      <!-- í—¤ë” -->
      <div class="chat-header">
        <div class="chat-title" id="chatTitle">ì±„íŒ…ë°©</div>
        <div class="header-buttons">
          <button class="header-btn" id="clearBtn">ì±„íŒ… í´ë¦¬ì–´</button>
          <button class="header-btn" id="exitBtn">ë‚˜ê°€ê¸°</button>
        </div>
      </div>

      <!-- ë©”ì‹œì§€ ì˜ì—­ -->
      <div class="messages-container" id="messagesContainer"></div>

      <!-- ì…ë ¥ ì˜ì—­ -->
      <div class="input-container">
        <div class="input-wrapper">
          <textarea
            id="messageInput"
            placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš” (Enter: ì „ì†¡, Shift+Enter: ì¤„ë°”ê¿ˆ)"
            rows="1"
          ></textarea>
          <button id="sendBtn">ì „ì†¡</button>
        </div>
      </div>
    </div>

    <!-- ì‚¬ì´ë“œ íŒ¨ë„ (ë‹¨ì¶•í‚¤ ì„¤ëª…) -->
    <div class="side-panel">
      <h3>âŒ¨ï¸ ë‹¨ì¶•í‚¤ ì•ˆë‚´</h3>
      <div class="shortcut-list">
        <div class="shortcut-item">
          <div class="shortcut-key">Enter</div>
          <div class="shortcut-desc">ë©”ì‹œì§€ ì „ì†¡</div>
        </div>
        <div class="shortcut-item">
          <div class="shortcut-key">Shift + Enter</div>
          <div class="shortcut-desc">ì¤„ë°”ê¿ˆ (ì—¬ëŸ¬ ì¤„ ì…ë ¥)</div>
        </div>
      </div>

      <div class="info-section">
        <h4>ğŸ’¡ ì•ˆë‚´ì‚¬í•­</h4>
        <div class="info-text">
          â€¢ ì±„íŒ… ë‚´ìš©ì€ ë¸Œë¼ìš°ì €ì—ë§Œ ì €ì¥ë©ë‹ˆë‹¤<br>
          â€¢ ìƒˆë¡œê³ ì¹¨ ì‹œ ë¡œê·¸ì¸ ìƒíƒœëŠ” ìœ ì§€ë˜ì§€ë§Œ ì±„íŒ… ë‚´ìš©ì€ ì´ˆê¸°í™”ë©ë‹ˆë‹¤<br>
          â€¢ ì±„íŒ…ì°½ì´ ê¸¸ì–´ì§€ë©´ 'ì±„íŒ… í´ë¦¬ì–´' ë²„íŠ¼ìœ¼ë¡œ ì •ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤<br>
          â€¢ ë‚˜ì˜ ë©”ì‹œì§€ëŠ” ë…¸ë€ìƒ‰, ë‹¤ë¥¸ ì‚¬ìš©ìëŠ” í°ìƒ‰ìœ¼ë¡œ í‘œì‹œë©ë‹ˆë‹¤
        </div>
      </div>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    const messagesContainer = document.getElementById('messagesContainer');
    const messageInput = document.getElementById('messageInput');
    const sendBtn = document.getElementById('sendBtn');
    const clearBtn = document.getElementById('clearBtn');
    const exitBtn = document.getElementById('exitBtn');
    const chatTitle = document.getElementById('chatTitle');

    // ë‹‰ë„¤ì„ í™•ì¸
    const myNickname = localStorage.getItem('chatNickname');
    if (!myNickname) {
      // ë‹‰ë„¤ì„ì´ ì—†ìœ¼ë©´ ë©”ì¸ í˜ì´ì§€ë¡œ
      window.location.href = '/';
    } else {
      chatTitle.textContent = `${myNickname}ë‹˜ì˜ ì±„íŒ…ë°©`;
      // ì„œë²„ì— ì¬ì—°ê²° ì•Œë¦¼
      socket.emit('reconnect nickname', myNickname);
    }

    // ì•Œë¦¼ ê¶Œí•œ ìš”ì²­
    if ('Notification' in window && Notification.permission === 'default') {
      Notification.requestPermission();
    }

    // í˜ì´ì§€ ê°€ì‹œì„± ì¶”ì 
    let isPageVisible = !document.hidden;
    let originalTitle = document.title;
    let unreadCount = 0;

    document.addEventListener('visibilitychange', () => {
      isPageVisible = !document.hidden;
      if (isPageVisible) {
        // í˜ì´ì§€ê°€ ë³´ì´ë©´ ì¹´ìš´íŠ¸ ì´ˆê¸°í™”
        unreadCount = 0;
        document.title = originalTitle;
      }
    });

    // í¬ì»¤ìŠ¤ ì´ë²¤íŠ¸ ì¶”ì 
    window.addEventListener('focus', () => {
      isPageVisible = true;
      unreadCount = 0;
      document.title = originalTitle;
    });

    window.addEventListener('blur', () => {
      isPageVisible = false;
    });

    // ëœë¤ ìƒ‰ìƒ ìƒì„± (ë³¸ì¸ ì œì™¸)
    const userColors = new Map();
    const colors = [
      '#8B7FFF', '#FF6B9D', '#4ECDC4', '#FF8B6A',
      '#95E1D3', '#F38181', '#AA96DA', '#FCBAD3'
    ];

    function getUserColor(nickname) {
      if (!userColors.has(nickname)) {
        const randomColor = colors[userColors.size % colors.length];
        userColors.set(nickname, randomColor);
      }
      return userColors.get(nickname);
    }

    // ë©”ì‹œì§€ ì¶”ê°€ í•¨ìˆ˜
    function addMessage(nickname, message, timestamp, isMine = false) {
      const wrapper = document.createElement('div');
      wrapper.className = `message-wrapper ${isMine ? 'mine' : 'others'}`;

      const content = document.createElement('div');
      content.className = 'message-content';

      if (!isMine) {
        const nicknameEl = document.createElement('div');
        nicknameEl.className = 'nickname';
        nicknameEl.textContent = nickname;
        content.appendChild(nicknameEl);
      }

      const bubble = document.createElement('div');
      bubble.className = 'message-bubble';
      bubble.textContent = message;

      if (!isMine) {
        bubble.style.background = getUserColor(nickname);
        bubble.style.color = 'white';
      }

      content.appendChild(bubble);
      wrapper.appendChild(content);

      const time = document.createElement('div');
      time.className = 'timestamp';
      time.textContent = timestamp;
      wrapper.appendChild(time);

      messagesContainer.appendChild(wrapper);
      scrollToBottom();
    }

    // ì‹œìŠ¤í…œ ë©”ì‹œì§€ ì¶”ê°€
    function addSystemMessage(message) {
      const div = document.createElement('div');
      div.className = 'system-message';
      div.textContent = message;
      messagesContainer.appendChild(div);
      scrollToBottom();
    }

    // í•˜ë‹¨ ìŠ¤í¬ë¡¤
    function scrollToBottom() {
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    // í˜„ì¬ ì‹œê°„ í¬ë§·
    function getCurrentTime() {
      const now = new Date();
      const hours = now.getHours();
      const minutes = now.getMinutes();
      const ampm = hours >= 12 ? 'ì˜¤í›„' : 'ì˜¤ì „';
      const displayHours = hours % 12 || 12;
      return `${ampm} ${displayHours}:${minutes.toString().padStart(2, '0')}`;
    }

    // ë©”ì‹œì§€ ì „ì†¡
    function sendMessage() {
      const message = messageInput.value.trim();
      if (!message) return;

      const timestamp = getCurrentTime();

      // ë‚´ ë©”ì‹œì§€ í™”ë©´ì— í‘œì‹œ
      addMessage(myNickname, message, timestamp, true);

      // ì„œë²„ë¡œ ì „ì†¡
      socket.emit('chat message', {
        message: message,
        timestamp: timestamp
      });

      // ì…ë ¥ì°½ ì´ˆê¸°í™”
      messageInput.value = '';
      messageInput.style.height = 'auto';
    }

    // ì „ì†¡ ë²„íŠ¼ í´ë¦­
    sendBtn.addEventListener('click', sendMessage);

    // Enter í‚¤ ì²˜ë¦¬ (í•œê¸€ IME ì¡°í•© ì¤‘ë³µ ë°©ì§€)
    let isComposing = false;

    messageInput.addEventListener('compositionstart', () => {
      isComposing = true;
    });

    messageInput.addEventListener('compositionend', () => {
      isComposing = false;
    });

    messageInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey && !isComposing) {
        e.preventDefault();
        sendMessage();
      }
    });

    // ìë™ ë†’ì´ ì¡°ì ˆ
    messageInput.addEventListener('input', () => {
      messageInput.style.height = 'auto';
      messageInput.style.height = messageInput.scrollHeight + 'px';
    });

    // ëª¨ë°”ì¼ í‚¤ë³´ë“œ ëŒ€ì‘ - ì…ë ¥ì°½ í¬ì»¤ìŠ¤ ì‹œ ìŠ¤í¬ë¡¤ í•˜ë‹¨ìœ¼ë¡œ
    messageInput.addEventListener('focus', () => {
      setTimeout(() => {
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
      }, 300);
    });

    // ëª¨ë°”ì¼ í™˜ê²½ì—ì„œ í‚¤ë³´ë“œ ì˜¬ë¼ì˜¬ ë•Œ ë©”ì‹œì§€ ì˜ì—­ ì¡°ì •
    if ('visualViewport' in window) {
      window.visualViewport.addEventListener('resize', () => {
        const viewportHeight = window.visualViewport.height;
        const windowHeight = window.innerHeight;

        if (viewportHeight < windowHeight) {
          // í‚¤ë³´ë“œê°€ ì˜¬ë¼ì˜¨ ìƒíƒœ
          document.body.style.height = `${viewportHeight}px`;
        } else {
          // í‚¤ë³´ë“œê°€ ë‚´ë ¤ê°„ ìƒíƒœ
          document.body.style.height = '100vh';
        }
      });
    }

    // ì±„íŒ… í´ë¦¬ì–´
    clearBtn.addEventListener('click', () => {
      if (confirm('ì±„íŒ… ë‚´ìš©ì„ ëª¨ë‘ ì§€ìš°ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        messagesContainer.innerHTML = '';
        addSystemMessage('ì±„íŒ… ë‚´ìš©ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
      }
    });

    // ë‚˜ê°€ê¸°
    exitBtn.addEventListener('click', () => {
      if (confirm('ì±„íŒ…ë°©ì„ ë‚˜ê°€ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        localStorage.removeItem('chatNickname');
        socket.disconnect();
        window.location.href = '/';
      }
    });

    // ë°ìŠ¤í¬í†± ì•Œë¦¼ í‘œì‹œ
    function showNotification(nickname, message) {
      if (!isPageVisible && 'Notification' in window && Notification.permission === 'granted') {
        const notification = new Notification(`${nickname}`, {
          body: message,
          icon: '/favicon.ico',
          badge: '/favicon.ico',
          tag: 'chat-message',
          requireInteraction: false
        });

        // ì•Œë¦¼ í´ë¦­ ì‹œ ì°½ í¬ì»¤ìŠ¤
        notification.onclick = () => {
          window.focus();
          notification.close();
        };

        // 5ì´ˆ í›„ ìë™ ë‹«ê¸°
        setTimeout(() => notification.close(), 5000);
      }
    }

    // íƒ€ì´í‹€ ì•Œë¦¼ ì—…ë°ì´íŠ¸
    function updateTitleNotification() {
      if (!isPageVisible && unreadCount > 0) {
        document.title = `(${unreadCount}) ìƒˆ ë©”ì‹œì§€ - ${originalTitle}`;
      }
    }

    // ì†Œì¼“ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
    socket.on('chat message', (data) => {
      addMessage(data.nickname, data.message, data.timestamp, false);

      // í˜ì´ì§€ê°€ ë³´ì´ì§€ ì•Šì„ ë•Œë§Œ ì•Œë¦¼
      if (!isPageVisible) {
        unreadCount++;
        updateTitleNotification();
        showNotification(data.nickname, data.message);
      }
    });

    socket.on('user joined', (data) => {
      addSystemMessage(`${data.nickname} ë‹˜ì´ ì…ì¥í•˜ì…¨ìŠµë‹ˆë‹¤.`);
    });

    socket.on('user left', (data) => {
      addSystemMessage(`${data.nickname} ë‹˜ì´ í‡´ì¥í•˜ì…¨ìŠµë‹ˆë‹¤.`);
    });

    // ì—°ê²° ìƒíƒœ ëª¨ë‹ˆí„°ë§
    socket.on('disconnect', () => {
      addSystemMessage('ì„œë²„ì™€ì˜ ì—°ê²°ì´ ëŠì–´ì¡ŒìŠµë‹ˆë‹¤.');
    });

    socket.on('connect', () => {
      // ì¬ì—°ê²° ì‹œ ë‹‰ë„¤ì„ ë³µêµ¬
      if (myNickname) {
        socket.emit('reconnect nickname', myNickname);
      }
    });

    // í˜ì´ì§€ ë¡œë“œ ì‹œ í™˜ì˜ ë©”ì‹œì§€
    addSystemMessage('ì±„íŒ…ë°©ì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤!');
  </script>
</body>
</html>
